apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: update-manifests
spec:
  inputs:
    resources:
    - name: manifests
      type: git
    - name: kubeflow
      type: git
    - name: $(image_name)
      type: image
    - name: $(pull_request_repo)-$(pull_request_id)
      type: pullRequest
    params:
    - name: pathToManifestsDir
      type: string
      description: Where the components manifest dir is
      default: /workspace/manifests
    - name: container_image
      type: string
      description: pod container image
  outputs:
    resources:
    - name: manifests
      type: git
  steps:
  - name: update-manifests
    workingDir: "/workspace/${inputs.resources.manifests.name}/${inputs.params.pathToManifestsDir}"
    image: ${inputs.params.container_image}
    command: ["/bin/sleep", "infinity"]
    #command: ["/workspace/kubeflow/py/kubeflow/kubeflow/ci/rebuild-manifests.sh"]
    env:
    - name: GOOGLE_APPLICATION_CREDENTIALS
      value: /secret/kaniko-secret.json
    envFrom:
    - configMapRef:
        name: ci-pipeline-parameters
    volumeMounts:
    - name: kaniko-secret
      mountPath: /secret
    - name: kubeflow
      mountPath: /kubeflow
  volumes:
  - name: kaniko-secret
    secret:
      secretName: kaniko-secret
  - name: kubeflow
    persistentVolumeClaim:
      claimName: ci-pipeline-run-persistent-volume-claim
